<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="initial-scale=1.0, width=device-width" />
  <link rel="stylesheet" type="text/css"
    href="https://js.api.here.com/v3/3.0/mapsjs-ui.css" />
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js">  </script>
  <script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
  <script type="text/javascript" charset="UTF-8"
    src="https://js.api.here.com/v3/3.0/mapsjs-core.js"></script>
  <script type="text/javascript" charset="UTF-8"
    src="https://js.api.here.com/v3/3.0/mapsjs-service.js"></script>
  <script type="text/javascript" charset="UTF-8"
    src="https://js.api.here.com/v3/3.0/mapsjs-ui.js"></script>
  <script type="text/javascript" charset="UTF-8"
    src="https://js.api.here.com/v3/3.0/mapsjs-mapevents.js"></script>
</head>
<body>
  <div id="map" style="width: 100%; height: 800px; background: grey" />
  <script  type="text/javascript" charset="UTF-8" >
    



$.ajax({
    url: "../getpath",
    //type: "get",
    //dataType: "json",
    //contentType: "application/json",
    //cache: false,
    complete: function() {
      //called when complete
      console.log('process complete');
    },

    success: function(data) {
      //json = JSON.parse(data);
        //json = data;
      //console.log(data);
      console.log('process success');
        //console.log(json);
		processedJSON = processJSON(data);
		fullTrip = calculateFullTrip(processedJSON)
		makeMap(processedJSON, fullTrip);
   },

    error: function() {
      console.log('process error');
    }
});

/**
 * Moves the map to display over Berlin
 *
 * @param  {H.Map} map      A HERE Map instance within the application
 */
  
function moveMapToBerlin(map){
  map.setCenter({lat:52.5159, lng:13.3777});
  map.setZoom(14);
}

function processJSON(json){
	var obj = json;
    //var obj = JSON.parse(json);
	//console.log(obj.route);
	//console.log(obj.route[0]);
	//console.log(obj.route[0].leg[0]);
	var maneuver = obj.response.route[0].leg[0].maneuver;
	var data = [[], [], []];
	for (var i = 0; i < maneuver.length; i++){
		data[0].push(maneuver[i].position.latitude);
		data[1].push(maneuver[i].position.longitude);
		data[2].push(maneuver[i].travelTime);
	}
    //console.log(data);
	return data;
}




/**
 * Boilerplate map initialization code starts below:
 */
function makeMap(points, fullTrip){
//Step 1: initialize communication with the platform
var platform = new H.service.Platform({
  app_id: 'coZYlKFfMv8P9SZZj5AF',
  app_code: 'b9mg-A1AaGwMKGdcIFPOJg',
  useCIT: true,
  useHTTPS: true
});
var defaultLayers = platform.createDefaultLayers();

//Step 2: initialize a map  - not specificing a location will give a whole world view.
var map = new H.Map(document.getElementById('map'),
  defaultLayers.normal.map);

//Step 3: make the map interactive
// MapEvents enables the event system
// Behavior implements default interactions for pan/zoom (also on mobile touch environments)
var behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));

// Create the default UI components
var ui = H.ui.UI.createDefault(map, defaultLayers);

var strip = new H.geo.Strip();


//var points = json;//processJSON(json);
for (var i = 0; i < points[0].length; i++){
	var p = new H.geo.Point(points[0][i], points[1][i]);
	strip.pushPoint(p);
}

var polyline = new H.map.Polyline(strip, { style: { lineWidth: 10 }});

// Add the polyline to the map:
map.addObject(polyline);

// Zoom the map to make sure the whole polyline is visible:
map.setViewBounds(polyline.getBounds());

for (var i = 0; i < fullTrip.length; i++){
	for (var j = 0; j < fullTrip[i].length; j++){
		//console.log(fullTrip[i]);
		var t = new H.map.Marker(fullTrip[i][j][0], fullTrip[i][j][1]);
		map.addObject(t);
	}
}

}

function calculateFullTrip(data){
	var totalRoute = [];
	var waypoint = 0;
	while (waypoint < data[0].length){
		var day = calculateRouteForDay(10, data[0], data[1], data[2], waypoint);
		totalRoute.push(day);
		waypoint++;
	}
	console.log(totalRoute);
	return totalRoute;
}

function calculateRouteForDay(timePerDay, latitudes, longitudes, timeLengths, waypoint){
	var data = [0, 0, 0, 0];
	var timePerDayInSeconds = timePerDay * 3600;
	var lunchPoint = timePerDayInSeconds / 3;
	var dinnerPoint = lunchPoint * 2;
	var lunchPointSet = false;
	var dinnerPointSet = false;
	var hotelPointSet = false;
	var waypoint = 0;
	var traveled = 0;
	while (traveled < timePerDayInSeconds){
		traveled += timeLengths[waypoint];
		waypoint++;
		if (traveled >= lunchPoint && !lunchPointSet){
			lunchPointSet = true;
			data[0] = [latitudes[waypoint], longitudes[waypoint]];
		}
		else if (traveled >= dinnerPoint && !dinnerPointSet){
			dinnerPointSet = true;
			data[1] = [latitudes[waypoint], longitudes[waypoint]];
		}
		else if (traveled >= timePerDayInSeconds && !hotelPointSet){
			hotelPointSet = true;
			data[2] = [latitudes[waypoint], longitudes[waypoint]];
		}
	}
	data[3] = waypoint;
	return data;
}

// Now use the map as required...
//moveMapToBerlin(map);
  </script>
</body>
</html>